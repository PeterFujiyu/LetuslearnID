<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>OIDC Demo</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh;}
    .container{width:360px;background:#fff;padding:30px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);text-align:center;}
    .button{width:100%;padding:10px;background:#000;color:#fff;border:none;border-radius:20px;cursor:pointer;margin-top:10px;}
    .button:hover{background:#333;}
  </style>
</head>
<body>
  <div class="container">
    <h1>OIDC 登录示例</h1>
    <button id="login" class="button">使用 LetuslearnID 登录</button>
  </div>
<script>
(async()=>{
  const rand=v=>Array.from(crypto.getRandomValues(new Uint8Array(v))).map(b=>('0'+b.toString(16)).slice(-2)).join('');
  const b64u=s=>btoa(String.fromCharCode(...new Uint8Array(s))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const sha256=async str=>{
    const data=new TextEncoder().encode(str);
    const hash=await crypto.subtle.digest('SHA-256',data);
    return new Uint8Array(hash);
  };
  document.getElementById('login').onclick=async()=>{
    const verifier=rand(32);
    const challenge=b64u(await sha256(verifier));
    const state=rand(16);
    sessionStorage.setItem('verifier',verifier);
    sessionStorage.setItem('state',state);
    const params=new URLSearchParams({
      client_id:'cloudreve',
      response_type:'code',
      scope:'openid email',
      redirect_uri:location.origin+'/oidc/callback.html',
      code_challenge:challenge,
      code_challenge_method:'S256',
      state
    });
    location.href='http://localhost:4000/oidc/auth?'+params.toString();
  };
})();
</script>
</body>
</html>
